local speciesArray = {"None","Bulbasaur","Ivysaur","Venusaur","Charmander","Charmeleon","Charizard","Squirtle","Wartortle","Blastoise","Caterpie","Metapod","Butterfree","Weedle","Kakuna","Beedrill","Pidgey","Pidgeotto","Pidgeot","Rattata","Raticate","Spearow","Fearow","Ekans","Arbok","Pikachu","Raichu","Sandshrew","Sandslash","Nidoran♀","Nidorina","Nidoqueen","Nidoran♂","Nidorino","Nidoking","Clefairy","Clefable","Vulpix","Ninetales","Jigglypuff","Wigglytuff","Zubat","Golbat","Oddish","Gloom","Vileplume","Paras","Parasect","Venonat","Venomoth","Diglett","Dugtrio","Meowth","Persian","Psyduck","Golduck","Mankey","Primeape","Growlithe","Arcanine","Poliwag","Poliwhirl","Poliwrath","Abra","Kadabra","Alakazam","Machop","Machoke","Machamp","Bellsprout","Weepinbell","Victreebel","Tentacool","Tentacruel","Geodude","Graveler","Golem","Ponyta","Rapidash","Slowpoke","Slowbro","Magnemite","Magneton","Farfetch'd","Doduo","Dodrio","Seel","Dewgong","Grimer","Muk","Shellder","Cloyster","Gastly","Haunter","Gengar","Onix","Drowzee","Hypno","Krabby","Kingler","Voltorb","Electrode","Exeggcute","Exeggutor","Cubone","Marowak","Hitmonlee","Hitmonchan","Lickitung","Koffing","Weezing","Rhyhorn","Rhydon","Chansey","Tangela","Kangaskhan","Horsea","Seadra","Goldeen","Seaking","Staryu","Starmie","Mr. Mime","Scyther","Jynx","Electabuzz","Magmar","Pinsir","Tauros","Magikarp","Gyarados","Lapras","Ditto","Eevee","Vaporeon","Jolteon","Flareon","Porygon","Omanyte","Omastar","Kabuto","Kabutops","Aerodactyl","Snorlax","Articuno","Zapdos","Moltres","Dratini","Dragonair","Dragonite","Mewtwo","Mew","Chikorita","Bayleef","Meganium","Cyndaquil","Quilava","Typhlosion","Totodile","Croconaw","Feraligatr","Sentret","Furret","Hoothoot","Noctowl","Ledyba","Ledian","Spinarak","Ariados","Crobat","Chinchou","Lanturn","Pichu","Cleffa","Igglybuff","Togepi","Togetic","Natu","Xatu","Mareep","Flaaffy","Ampharos","Bellossom","Marill","Azumarill","Sudowoodo","Politoed","Hoppip","Skiploom","Jumpluff","Aipom","Sunkern","Sunflora","Yanma","Wooper","Quagsire","Espeon","Umbreon","Murkrow","Slowking","Misdreavus","Unown","Wobbuffet","Girafarig","Pineco","Forretress","Dunsparce","Gligar","Steelix","Snubbull","Granbull","Qwilfish","Scizor","Shuckle","Heracross","Sneasel","Teddiursa","Ursaring","Slugma","Magcargo","Swinub","Piloswine","Corsola","Remoraid","Octillery","Delibird","Mantine","Skarmory","Houndour","Houndoom","Kingdra","Phanpy","Donphan","Porygon2","Stantler","Smeargle","Tyrogue","Hitmontop","Smoochum","Elekid","Magby","Miltank","Blissey","Raikou","Entei","Suicune","Larvitar","Pupitar","Tyranitar","Lugia","Ho-Oh","Celebi","? (glitch Pokémon)","? (glitch Pokémon)","? (glitch Pokémon)","? (glitch Pokémon)","? (glitch Pokémon)","? (glitch Pokémon)","? (glitch Pokémon)","? (glitch Pokémon)","? (glitch Pokémon)","? (glitch Pokémon)","? (glitch Pokémon)","? (glitch Pokémon)","? (glitch Pokémon)","? (glitch Pokémon)","? (glitch Pokémon)","? (glitch Pokémon)","? (glitch Pokémon)","? (glitch Pokémon)","? (glitch Pokémon)","? (glitch Pokémon)","? (glitch Pokémon)","? (glitch Pokémon)","? (glitch Pokémon)","? (glitch Pokémon)","? (glitch Pokémon)","Treecko","Grovyle","Sceptile","Torchic","Combusken","Blaziken","Mudkip","Marshtomp","Swampert","Poochyena","Mightyena","Zigzagoon","Linoone","Wurmple","Silcoon","Beautifly","Cascoon","Dustox","Lotad","Lombre","Ludicolo","Seedot","Nuzleaf","Shiftry","Nincada","Ninjask","Shedinja","Taillow","Swellow","Shroomish","Breloom","Spinda","Wingull","Pelipper","Surskit","Masquerain","Wailmer","Wailord","Skitty","Delcatty","Kecleon","Baltoy","Claydol","Nosepass","Torkoal","Sableye","Barboach","Whiscash","Luvdisc","Corphish","Crawdaunt","Feebas","Milotic","Carvanha","Sharpedo","Trapinch","Vibrava","Flygon","Makuhita","Hariyama","Electrike","Manectric","Numel","Camerupt","Spheal","Sealeo","Walrein","Cacnea","Cacturne","Snorunt","Glalie","Lunatone","Solrock","Azurill","Spoink","Grumpig","Plusle","Minun","Mawile","Meditite","Medicham","Swablu","Altaria","Wynaut","Duskull","Dusclops","Roselia","Slakoth","Vigoroth","Slaking","Gulpin","Swalot","Tropius","Whismur","Loudred","Exploud","Clamperl","Huntail","Gorebyss","Absol","Shuppet","Banette","Seviper","Zangoose","Relicanth","Aron","Lairon","Aggron","Castform","Volbeat","Illumise","Lileep","Cradily","Anorith","Armaldo","Ralts","Kirlia","Gardevoir","Bagon","Shelgon","Salamence","Beldum","Metang","Metagross","Regirock","Regice","Registeel","Kyogre","Groudon","Rayquaza","Latias","Latios","Jirachi","Deoxys","Chimecho","Pokémon Egg","Unown","Unown","Unown","Unown","Unown","Unown","Unown","Unown","Unown","Unown","Unown","Unown","Unown","Unown","Unown","Unown","Unown","Unown","Unown","Unown","Unown","Unown","Unown","Unown","Unown","Unown","Unown"}

local movesArray = {"None", "Pound", "Karate Chop", "Double Slap", "Comet Punch", "Mega Punch", "Pay Day", "Fire Punch", "Ice Punch", "Thunder Punch", "Scratch", "Vice Grip", "Guillotine", "Razor Wind", "Swords Dance", "Cut", "Gust", "Wing Attack", "Whirlwind", "Fly", "Bind", "Slam", "Vine Whip", "Stomp", "Double Kick", "Mega Kick", "Jump Kick", "Rolling Kick", "Sand Attack", "Headbutt", "Horn Attack", "Fury Attack", "Horn Drill", "Tackle", "Body Slam", "Wrap", "Take Down", "Thrash", "Double-Edge", "Tail Whip", "Poison Sting", "Twineedle", "Pin Missile", "Leer", "Bite", "Growl", "Roar", "Sing", "Supersonic", "Sonic Boom", "Disable", "Acid", "Ember", "Flamethrower", "Mist", "Water Gun", "Hydro Pump", "Surf", "Ice Beam", "Blizzard", "Psybeam", "Bubble Beam", "Aurora Beam", "Hyper Beam", "Peck", "Drill Peck", "Submission", "Low Kick", "Counter", "Seismic Toss", "Strength", "Absorb", "Mega Drain", "Leech Seed", "Growth", "Razor Leaf", "Solar Beam", "Poison Powder", "Stun Spore", "Sleep Powder", "Petal Dance", "String Shot", "Dragon Rage", "Fire Spin", "Thunder Shock", "Thunderbolt", "Thunder Wave", "Thunder", "Rock Throw", "Earthquake", "Fissure", "Dig", "Toxic", "Confusion", "Psychic", "Hypnosis", "Meditate", "Agility", "Quick Attack", "Rage", "Teleport", "Night Shade", "Mimic", "Screech", "Double Team", "Recover", "Harden", "Minimize", "Smokescreen", "Confuse Ray", "Withdraw", "Defense Curl", "Barrier", "Light Screen", "Haze", "Reflect", "Focus Energy", "Bide", "Metronome", "Mirror Move", "Self-Destruct", "Egg Bomb", "Lick", "Smog", "Sludge", "Bone Club", "Fire Blast", "Waterfall", "Clamp", "Swift", "Skull Bash", "Spike Cannon", "Constrict", "Amnesia", "Kinesis", "Soft-Boiled", "High Jump Kick", "Glare", "Dream Eater", "Poison Gas", "Barrage", "Leech Life", "Lovely Kiss", "Sky Attack", "Transform", "Bubble", "Dizzy Punch", "Spore", "Flash", "Psywave", "Splash", "Acid Armor", "Crabhammer", "Explosion", "Fury Swipes", "Bonemerang", "Rest", "Rock Slide", "Hyper Fang", "Sharpen", "Conversion", "Tri Attack", "Super Fang", "Slash", "Substitute", "Struggle", "Sketch", "Triple Kick", "Thief", "Spider Web", "Mind Reader", "Nightmare", "Flame Wheel", "Snore", "Curse", "Flail", "Conversion 2", "Aeroblast", "Cotton Spore", "Reversal", "Spite", "Powder Snow", "Protect", "Mach Punch", "Scary Face", "Feint Attack", "Sweet Kiss", "Belly Drum", "Sludge Bomb", "Mud-Slap", "Octazooka", "Spikes", "Zap Cannon", "Foresight", "Destiny Bond", "Perish Song", "Icy Wind", "Detect", "Bone Rush", "Lock-On", "Outrage", "Sandstorm", "Giga Drain", "Endure", "Charm", "Rollout", "False Swipe", "Swagger", "Milk Drink", "Spark", "Fury Cutter", "Steel Wing", "Mean Look", "Attract", "Sleep Talk", "Heal Bell", "Return", "Present", "Frustration", "Safeguard", "Pain Split", "Sacred Fire", "Magnitude", "Dynamic Punch", "Megahorn", "Dragon Breath", "Baton Pass", "Encore", "Pursuit", "Rapid Spin", "Sweet Scent", "Iron Tail", "Metal Claw", "Vital Throw", "Morning Sun", "Synthesis", "Moonlight", "Hidden Power", "Cross Chop", "Twister", "Rain Dance", "Sunny Day", "Crunch", "Mirror Coat", "Psych Up", "Extreme Speed", "Ancient Power", "Shadow Ball", "Future Sight", "Rock Smash", "Whirlpool", "Beat Up", "Fake Out", "Uproar", "Stockpile", "Spit Up", "Swallow", "Heat Wave", "Hail", "Torment", "Flatter", "Will-O-Wisp", "Memento", "Facade", "Focus Punch", "Smelling Salts", "Follow Me", "Nature Power", "Charge", "Taunt", "Helping Hand", "Trick", "Role Play", "Wish", "Assist", "Ingrain", "Superpower", "Magic Coat", "Recycle", "Revenge", "Brick Break", "Yawn", "Knock Off", "Endeavor", "Eruption", "Skill Swap", "Imprison", "Refresh", "Grudge", "Snatch", "Secret Power", "Dive", "Arm Thrust", "Camouflage", "Tail Glow", "Luster Purge", "Mist Ball", "Feather Dance", "Teeter Dance", "Blaze Kick", "Mud Sport", "Ice Ball", "Needle Arm", "Slack Off", "Hyper Voice", "Poison Fang", "Crush Claw", "Blast Burn", "Hydro Cannon", "Meteor Mash", "Astonish", "Weather Ball", "Aromatherapy", "Fake Tears", "Air Cutter", "Overheat", "Odor Sleuth", "Rock Tomb", "Silver Wind", "Metal Sound", "Grass Whistle", "Tickle", "Cosmic Power", "Water Spout", "Signal Beam", "Shadow Punch", "Extrasensory", "Sky Uppercut", "Sand Tomb", "Sheer Cold", "Muddy Water", "Bullet Seed", "Aerial Ace", "Icicle Spear", "Iron Defense", "Block", "Howl", "Dragon Claw", "Frenzy Plant", "Bulk Up", "Bounce", "Mud Shot", "Poison Tail", "Covet", "Volt Tackle", "Magical Leaf", "Water Sport", "Calm Mind", "Leaf Blade", "Dragon Dance", "Rock Blast", "Shock Wave", "Water Pulse", "Doom Desire", "Psycho Boost"}

local naturename={
 "Hardy","Lonely","Brave","Adamant","Naughty",
 "Bold","Docile","Relaxed","Impish","Lax",
 "Timid","Hasty","Serious","Jolly","Naive",
 "Modest","Mild","Quiet","Bashful","Rash",
 "Calm","Gentle","Sassy","Careful","Quirky"}

local typeorder={
"Fighting","Flying","Poison","Ground",
"Rock","Bug","Ghost","Steel",
"Fire","Water","Grass","Electric",
"Psychic","Ice","Dragon","Dark"}


local mword = memory.readwordunsigned
local mdword = memory.readdwordunsigned
local band = bit.band
local bxor = bit.bxor
local mbyte = memory.readbyte


-- Region and Game check

local version = mbyte(0x080000AE)
local region = mbyte(0x080000AF)
  if version == 0x50 and region == 0x45 then
    print("USA Sapphire detected")
    print("Press 1-6 for Party Slots and 7 for Wild View.")
  elseif version == 0x56 and region == 0x45 then
      print("USA Ruby detected")
      print("Press 1-6 for Party Slots and 7 for Wild View.")
  else
    print("Game not detected. Unknown version, code: %2X", version)
  end

-- Location Switch function

function switchLocation(location)
  local keys = input.get()

  if keys["1"] then
    location = 0x03004360 -- Location for party view
    gui.text(5, 5, "Party 1")
  elseif keys["2"] then
    location = 0x03004360 + 100
    gui.text(5, 5, "Party 2")
  elseif keys["3"] then
    location = 0x03004360 + 200
    gui.text(5, 5, "Party 3")
  elseif keys["4"] then
    location = 0x03004360 + 300
    gui.text(5, 5, "Party 4")
  elseif keys["5"] then
    location = 0x03004360 + 400
    gui.text(5, 5, "Party 5")
  elseif keys["6"] then
    location = 0x03004360 + 500
    gui.text(5, 5, "Party 6")
  elseif keys["7"]  then
    location = 0x030045C0 -- Location for wild view
    gui.text(5, 5, "Wild")
  end

  return location
end

-- Offsets order for data substructures 0-23

local offsetOrder = {}
offsetOrder[1] = {"G", "A", "E", "M"}
offsetOrder[2] ={"G", "A", "M", "E"}
offsetOrder[3] ={"G", "E", "A", "M"}
offsetOrder[4] ={"G", "E", "M", "A"}
offsetOrder[5] ={"G", "M", "A", "E"}
offsetOrder[6] ={"G", "M", "E", "A"}
offsetOrder[7] ={"A", "G", "E", "M"}
offsetOrder[8] ={"A", "G", "M", "E"}
offsetOrder[9] ={"A", "E", "G", "M"}
offsetOrder[10] ={"A", "E", "M", "G"}
offsetOrder[11] ={"A", "M", "G", "E"}
offsetOrder[12] ={"A", "M", "E", "G"}
offsetOrder[13] ={"E", "G", "A", "M"}
offsetOrder[14] ={"E", "G", "M", "A"}
offsetOrder[15] ={"E", "A", "G", "M"}
offsetOrder[16] ={"E", "A", "M", "G"}
offsetOrder[17] ={"E", "M", "G", "A"}
offsetOrder[18] ={"E", "M", "A", "G"}
offsetOrder[19] ={"M", "G", "A", "E"}
offsetOrder[20] ={"M", "G", "E", "A"}
offsetOrder[21] ={"M", "A", "G", "E"}
offsetOrder[22] ={"M", "A", "E", "G"}
offsetOrder[23] ={"M", "E", "G", "A"}
offsetOrder[24] ={"M", "E", "A", "G"}

-- function to get the offset amount for each substructure

function getOffset(personality, offsetLetter)

  local i = personality % 24
  local pkmnOrder = offsetOrder[i+1]

  for j = 1, 4, 1 do
    if pkmnOrder[j] == offsetLetter then
      return (j-1) * 12
    end
  end

  return 0

end

function getmagicword(location, personality)
  local trainerid = mdword(location + 4)
  local magicword = bxor(personality, trainerid)

  return magicword
end

-- returns the offset location for the substructures and decrypts

function getDecryptedDWord(location, dataOffset, valueOffset, magicword)
  local finalOffset = location + dataOffset + valueOffset
  return decryptDword(finalOffset, magicword)
end

function getDecryptedWord(location, dataOffset, valueOffset, magicword)
  return band(getDecryptedDWord(location, dataOffset, valueOffset, magicword), 0xFFFF)
end

function decryptDword(dwordLocation, magicword)
  return bxor(mdword(dwordLocation), magicword)
end

function getSpecies(location, growthoffset, magicword)
  local speciesLocation = location + 32 + growthoffset
  local species = band(bxor(mdword(speciesLocation), magicword), 0xFFF)

  return species
end

function getMoves(location, atkoffset, magicword)
  local movesLocation = location + 32 + atkoffset
  local moves =bxor(mdword(movesLocation), magicword)

  return moves
end

function getIvs(location, miscoffset, magicword)
  local ivsLocation = location + 32 + miscoffset
  local ivs = bxor(mdword(ivsLocation), magicword)

  return ivs
end


local location = 0x03004360 -- default location is party slot 1

while true do

  location = switchLocation(location)
  local personality = mdword(location)
  local magicword = getmagicword(location, personality)
  local growthoffset = getOffset(personality, "G")
  local atkoffset = getOffset(personality, "A")
  local miscoffset = getOffset(personality, "M")
  local species = getSpecies(location, growthoffset, magicword)
  local level = location + 84
  local nature = personality % 25

  local moves12 = getMoves(location, atkoffset, magicword)
  local moves34 = getMoves(location, atkoffset + 4, magicword)
  local move4 = math.floor(moves34 / 0x10000)
  local move3 = band(moves34, 0xFF)
  local move2 = math.floor(moves12 / 0x10000)
  local move1 = band(moves12, 0xFF)

  local ivs = getIvs(location, miscoffset + 4, magicword)
  local hpiv = band(ivs, 0x1F)
  local atkiv = band(ivs, 0x1F * 0x20) / 0x20
  local defiv = band(ivs, 0x1F * 0x400) / 0x400
  local spdiv = band(ivs, 0x1F * 0x8000) / 0x8000
  local spatkiv = band(ivs, 0x1F * 0x100000) / 0x100000
  local spdefiv = band(ivs, 0x1F * 0x2000000) / 0x2000000

  local hidpowtype = math.floor(((hpiv%2 + 2*(atkiv%2) + 4*(defiv%2) + 8*(spdiv%2) + 16*(spatkiv%2) + 32*(spdefiv%2))*15)/63)
  local hidpowbase = math.floor(((band(hpiv,2)/2 + band(atkiv,2) + 2*band(defiv,2) + 4*band(spdiv,2) + 8*band(spatkiv,2) + 16*band(spdefiv,2))*40)/63 + 30)

  local currseed = mdword(0x03004818)
  local tid = mword(0x02024EAE)
  local sid = mword(0x02024EB0)

  gui.text(5, 120, string.format("%05d", tid))
  gui.text(25, 120, "/"..string.format("%05d", sid))

  local frame = vba.framecount()
  gui.text(5, 130, "Frame: " ..string.format(frame))
  gui.text(5, 138, "CurrSeed: " ..string.format("%08X", currseed))

  gui.text(35, 15, speciesArray[species+1])
  gui.text(5, 15, "Lv."..string.format("%d", memory.readbyte(level)))
  gui.text(5, 25, "PID: " ..string.format("%08X", personality))
  gui.text(5, 35,"Nature: "..naturename[nature+1])
  gui.text(5, 45, "IVs: " ..string.format("%02d/%02d/%02d/%02d/%02d/%02d" ,hpiv, atkiv, defiv, spatkiv, spdefiv, spdiv))
  gui.text(5, 55, "HP: " ..typeorder[hidpowtype+1].." "..hidpowbase)
  gui.text(5, 65, movesArray[move1+1])
  gui.text(5, 75, movesArray[move2+1])
  gui.text(50, 65, movesArray[move3+1])
  gui.text(50, 75, movesArray[move4+1])

  emu.frameadvance()
end
